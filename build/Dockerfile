# Build stage
ARG BUILD_IMAGE
FROM $BUILD_IMAGE AS builder
ARG BUILD_DIR
ARG OS
ARG ARCH
ARG GO111MODULE
ARG GOFLAGS
ARG OUTBIN
ARG VERSION
ARG COMMIT_SHA1
ARG BUILD_DATE
ARG PWD
WORKDIR $PWD

COPY . .
RUN chmod +x $BUILD_DIR/build.sh && $BUILD_DIR/build.sh

# Final stage
FROM alpine:3.8 AS final
ARG BIN
ARG OS
ARG ARCH
ARG VERSION
ARG COMMIT_SHA1
ARG BUILD_DATE
LABEL NAME=$BIN
LABEL OS=$OS
LABEL ARCH=$ARCH
LABEL VERSION=$VERSION
LABEL COMMIT_SHA1=$COMMIT_SHA1
LABEL BUILD_DATE=$BUILD_DATE

RUN apk --no-cache add ca-certificates
ARG OUTBIN
COPY --from=builder $OUTBIN /$BIN
ENV BIN=$BIN
ENTRYPOINT /$BIN
EXPOSE 9176
